#!/bin/bash

VMNAME="OSX-kali"
USER="xychix"

function startpentest {
  IP=`VBoxManage guestproperty get ${VMNAME} "/VirtualBox/GuestInfo/Net/0/V4/IP" |awk '{print $2}'`
  RUNNING=`VBoxManage showvminfo ${VMNAME} | grep -E "^State.*running"`
  echo "[d] Debug: $IP / $RUNNING" 
  if [ -n "${RUNNING}" -a -n "${IP}" ]; then
    ssh ${USER}@`VBoxManage guestproperty enumerate ${VMNAME}|grep "/VirtualBox/GuestInfo/Net/0/V4/IP"|awk '{print $4}'|sed s/,//g`
  elif [ ${RUNNING} ]; then
	echo "[e] oi oi, vm is running but has no IP. Sleep 5 seconds and try again!\nIf this loops your on your own!"
	startpentest
  else
    echo "[i] ${VMNAME} isn't running. Boot and sleep for 20 seconds. (Keep an eye out for errors or a machine starting)"
    VBoxManage startvm ${VMNAME}
	sleep 20
	startpentest
  fi
}

function killpentest {
  VBoxManage controlvm ${VMNAME} poweroff
}

if [ "$1" == "kill" ]; then
  killpentest
else
  osascript -e "tell application \"Terminal\" to set current settings of front window to settings set \"Ocean\""
  startpentest
  osascript -e "tell application \"Terminal\" to set current settings of front window to settings set \"Basic\""
fi
